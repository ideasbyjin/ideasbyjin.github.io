<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>My favourite Pandas tricks | Read between the rows</title>

<meta name="keywords" content="" />
<meta name="description" content="Pandas tips &amp; tricks">
<meta name="author" content="">
<link rel="canonical" href="https://ideasbyjin.github.io/post/2021-01-26-pandas/" />
<link href="/assets/css/stylesheet.min.fcb80b353216e4777efae25d075e5273a332ae8e4d09cc9e945f496c58eb44ca.css" integrity="sha256-/LgLNTIW5Hd&#43;&#43;uJdB15Sc6Myro5NCcyelF9JbFjrRMo=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://ideasbyjin.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ideasbyjin.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ideasbyjin.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ideasbyjin.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://ideasbyjin.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.83.0" />



<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><meta property="og:title" content="My favourite Pandas tricks" />
<meta property="og:description" content="Pandas tips &amp; tricks" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ideasbyjin.github.io/post/2021-01-26-pandas/" />
<meta property="article:published_time" content="2021-01-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-26T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="My favourite Pandas tricks"/>
<meta name="twitter:description" content="Pandas tips &amp; tricks"/>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "My favourite Pandas tricks",
  "name": "My favourite Pandas tricks",
  "description": "Pandas tips \u0026amp;amp; tricks",
  "keywords": [
    
  ],
  "articleBody": "These are some Pandas tricks I use frequently; I hope it’s just as useful to you too!\nUpdate: we’ll now use iris for this (thanks Sam!):\nfrom sklearn.datasets import load_iris import pandas as pd iris = load_iris() df = pd.DataFrame( data = iris['data'], columns = iris['feature_names'] ) df['species'] = iris['target_names'][iris['target']] df.head(3) .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  Visual aids TQDM I absolutely love TQDM, partly because of how much I end up coding in IPython or a Jupyter environment. It’s always helpful to know how far along I’ve gone along in applying some function:\nfrom tqdm import tqdm tqdm.pandas() def foo(z: float) - bool: \"\"\" A pretty meaningless function \"\"\" if z = 5: return 1 else: return 0 # foo is a function to apply on a value of the column df['sepal length (cm)'].progress_apply(lambda z: foo(z)) # watch magic happen! 100%|██████████| 150/150 [00:00 Plotting! I don’t think I take advantage of this feature enough, partly because libraries like Seaborn, plotly, plotnine and Altair all work natively with Dataframe objects. But if you just want something quick, these go a long way, too:\n_ = df['sepal length (cm)'].hist() _ = df.plot(x = 'sepal length (cm)', y = 'sepal width (cm)', kind = 'scatter') Column manipulation Strings as aggregation functions There’s loads of these, e.g. std, mean, first, etc…\ndf.groupby(\"species\").agg({ \"petal length (cm)\": \"mean\", \"petal width (cm)\": \"std\" }) .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  Getting unique values Gone are the days of using something like set(df[\"column\"]); behold, unique and nunique are your friend!\ndf['species'].unique() array(['setosa', 'versicolor', 'virginica'], dtype=object)  df['species'].nunique() 3  # this also works df[df['sepal length (cm)']  6].agg( { \"species\": \"unique\" } ) species [versicolor, virginica] dtype: object  Slightly more efficient CSV reading/handling Only getting some columns This is a three-stage process, but it saves memory, and leads to faster reading too, which is a bonus! Notice how, without this, it can be a big TSV to read:\nPATH = \"../gene_exp/E-MTAB-5214-query-results.tpms.tsv\" gtex = pd.read_csv(PATH, comment='#', sep='\\t') gtex .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  Let’s do this a bit better:\ndef get_col(column_name: str) - bool: \"\"\" Simple function to filter column names \"\"\" if \"gene\" in column_name.lower() or \"blood\" in column_name.lower(): return True else: return False # Get the header by reading the first line header = pd.read_csv(PATH, nrows = 1, sep='\\t', comment='#').columns # Filter the columns of interest usecols = [c for c in header if get_col(c)] # now read it gtex = pd.read_csv(PATH, usecols = usecols, comment='#', sep = '\\t') gtex .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  Chunkifying data I have to credit my old colleague Magda for this trick:\nimport re pattern = re.compile(r\"^IL1[A-Z]$\") def filter_interleukin1(chunk): \"\"\" Apply a regex to filter out chunks \"\"\" return chunk[ chunk['Gene Name'].apply(lambda z: True if pattern.findall(z) else False) ] gtex = pd.concat( [filter_interleukin1(chunk) for chunk in pd.read_csv(\"../gene_exp/E-MTAB-5214-query-results.tpms.tsv\", sep='\\t', comment = '#', iterator=True, chunksize=1000)] ) gtex .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  Memory efficiency This is not what I do immediately, but I find that it sometimes has benefits, especially when memory is a bit precious and I have to make ends meet:\npd.to_numeric(df['numeric_column'], downcast='unsigned') # only really works for positive integers pd.to_numeric(df['numeric_column'], downcast='Sparse[int]') # more effective with lots of 0s df['column'].astype(bool) # is your data full of 0s and 1s...? SQL(?) for Pandas Yes, you can call SQL via Pandas, e.g.\nconn = sqlite3.connect() # or a sqlalchemy connection... etc. pd.read_sql(\"\"\"SELECT * FROM ... \"\"\", con = conn) but you can also write string queries for your Pandas data! Let’s look at iris again:\ndf.head(5) .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  # you may know this as df[df['species'] == 'setosa'] df.query(\"species == 'setosa'\").head(10) .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  I find this is slightly more readable, especially when there’s lots of conditions, such as:\n# you may know this as df[(df['species'] == 'setosa')\u0026(df['sepal width (cm)'] df.query(\"species == 'setosa' and `sepal width (cm)` ).head(10) .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }  Serialisation While TSV/CSV is the go-to format for many, I’ve found that working with them can be a bit of a pain, especially when my files get big. Some formats I’ve played with lately are Apache’s feather and Parquet formats.\nWhile they sometimes don’t offer as much compression as the humble gzip, they’re still much better at reading; remember to have pyarrow installed!\ndf.to_parquet() pd.read_parquet() Next time I’ll cover numba, which has been one of the most exciting things I’ve worked with lately.\n",
  "wordCount" : "837",
  "inLanguage": "en",
  "datePublished": "2021-01-26T00:00:00Z",
  "dateModified": "2021-01-26T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ideasbyjin.github.io/post/2021-01-26-pandas/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Read between the rows",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ideasbyjin.github.io/favicon.ico"
    }
  }
}
</script>



</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ideasbyjin.github.io/" accesskey="h" title="Read between the rows (Alt + H)">Read between the rows</a>
            <span class="logo-switches">
                <a id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </a>
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://ideasbyjin.github.io/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://ideasbyjin.github.io/archives" title="archive">
                    <span>archive</span>
                </a>
            </li>
            <li>
                <a href="https://ideasbyjin.github.io/about" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://ideasbyjin.github.io/" title="home">
                    <span>home</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">

    <h1 class="post-title">
      My favourite Pandas tricks
    </h1>
    <div class="post-meta">January 26, 2021&nbsp;·&nbsp;4 min

</div>
  </header> 

  <div class="toc">
    <details >
      <summary accesskey="c" title="(Alt + C)">
        <div class="details">Table of Contents</div>
      </summary>
      <div class="inner"><ul><li>
        <a href="#visual-aids" aria-label="Visual aids">Visual aids</a><ul>
            <li>
        <a href="#tqdm" aria-label="TQDM">TQDM</a></li><li>
        <a href="#plotting" aria-label="Plotting!">Plotting!</a></li></ul>
    </li><li>
        <a href="#column-manipulation" aria-label="Column manipulation">Column manipulation</a><ul>
            <li>
        <a href="#strings-as-aggregation-functions" aria-label="Strings as aggregation functions">Strings as aggregation functions</a></li><li>
        <a href="#getting-unique-values" aria-label="Getting unique values">Getting unique values</a></li></ul>
    </li><li>
        <a href="#slightly-more-efficient-csv-readinghandling" aria-label="Slightly more efficient CSV reading/handling">Slightly more efficient CSV reading/handling</a><ul>
            <li>
        <a href="#only-getting-some-columns" aria-label="Only getting some columns">Only getting some columns</a></li><li>
        <a href="#chunkifying-data" aria-label="Chunkifying data">Chunkifying data</a></li><li>
        <a href="#memory-efficiency" aria-label="Memory efficiency">Memory efficiency</a></li></ul>
    </li><li>
        <a href="#sql-for-pandas" aria-label="SQL(?) for Pandas">SQL(?) for Pandas</a></li><li>
        <a href="#serialisation" aria-label="Serialisation">Serialisation</a></li></ul>
      </div>
    </details>
  </div>
  <div class="post-content">
<p>These are some Pandas tricks I use frequently; I hope it&rsquo;s just as useful to you too!</p>
<p>Update: we&rsquo;ll now use <code>iris</code> for this (thanks <a href="https://twitter.com/samdemharter">Sam</a>!):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> sklearn.datasets <span style="color:#f92672">import</span> load_iris
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd

iris <span style="color:#f92672">=</span> load_iris()
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(
    data <span style="color:#f92672">=</span> iris[<span style="color:#e6db74">&#39;data&#39;</span>],
    columns <span style="color:#f92672">=</span> iris[<span style="color:#e6db74">&#39;feature_names&#39;</span>]
)
df[<span style="color:#e6db74">&#39;species&#39;</span>] <span style="color:#f92672">=</span> iris[<span style="color:#e6db74">&#39;target_names&#39;</span>][iris[<span style="color:#e6db74">&#39;target&#39;</span>]]
df<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">3</span>)
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h2 id="visual-aids">Visual aids<a hidden class="anchor" aria-hidden="true" href="#visual-aids">#</a></h2>
<h3 id="tqdm">TQDM<a hidden class="anchor" aria-hidden="true" href="#tqdm">#</a></h3>
<p>I absolutely love TQDM, partly because of how much I end up coding in <code>IPython</code> or a Jupyter environment.
It&rsquo;s always helpful to know how far along I&rsquo;ve gone along in applying some function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm
tqdm<span style="color:#f92672">.</span>pandas()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(z: float) <span style="color:#f92672">-&gt;</span> bool:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    A pretty meaningless function
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> z <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">5</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>

<span style="color:#75715e"># foo is a function to apply on a value of the column</span>
df[<span style="color:#e6db74">&#39;sepal length (cm)&#39;</span>]<span style="color:#f92672">.</span>progress_apply(<span style="color:#66d9ef">lambda</span> z: foo(z)) <span style="color:#75715e"># watch magic happen!</span>
</code></pre></div><pre><code>100%|██████████| 150/150 [00:00&lt;00:00, 81930.67it/s]





0      1
1      0
2      0
3      0
4      1
      ..
145    1
146    1
147    1
148    1
149    1
Name: sepal length (cm), Length: 150, dtype: int64
</code></pre>
<h3 id="plotting">Plotting!<a hidden class="anchor" aria-hidden="true" href="#plotting">#</a></h3>
<p>I don&rsquo;t think I take advantage of this feature enough, partly because libraries like Seaborn, plotly, plotnine
and Altair all work natively with <code>Dataframe</code> objects. But if you just want something quick, these go a long
way, too:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">_ <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;sepal length (cm)&#39;</span>]<span style="color:#f92672">.</span>hist()
</code></pre></div><!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">_ <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>plot(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sepal length (cm)&#39;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sepal width (cm)&#39;</span>, kind <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;scatter&#39;</span>)
</code></pre></div><!-- raw HTML omitted -->
<h2 id="column-manipulation">Column manipulation<a hidden class="anchor" aria-hidden="true" href="#column-manipulation">#</a></h2>
<h3 id="strings-as-aggregation-functions">Strings as aggregation functions<a hidden class="anchor" aria-hidden="true" href="#strings-as-aggregation-functions">#</a></h3>
<p>There&rsquo;s loads of these, e.g. <code>std</code>, <code>mean</code>, <code>first</code>, etc&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#34;species&#34;</span>)<span style="color:#f92672">.</span>agg({
    <span style="color:#e6db74">&#34;petal length (cm)&#34;</span>: <span style="color:#e6db74">&#34;mean&#34;</span>,
    <span style="color:#e6db74">&#34;petal width (cm)&#34;</span>: <span style="color:#e6db74">&#34;std&#34;</span>
})
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h3 id="getting-unique-values">Getting unique values<a hidden class="anchor" aria-hidden="true" href="#getting-unique-values">#</a></h3>
<p>Gone are the days of using something like <code>set(df[&quot;column&quot;])</code>; behold, <code>unique</code> and <code>nunique</code> are your friend!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;species&#39;</span>]<span style="color:#f92672">.</span>unique()
</code></pre></div><pre><code>array(['setosa', 'versicolor', 'virginica'], dtype=object)
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;species&#39;</span>]<span style="color:#f92672">.</span>nunique()
</code></pre></div><pre><code>3
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># this also works</span>
df[df[<span style="color:#e6db74">&#39;sepal length (cm)&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">6</span>]<span style="color:#f92672">.</span>agg(
    {
        <span style="color:#e6db74">&#34;species&#34;</span>: <span style="color:#e6db74">&#34;unique&#34;</span>
    }
)
</code></pre></div><pre><code>species    [versicolor, virginica]
dtype: object
</code></pre>
<h2 id="slightly-more-efficient-csv-readinghandling">Slightly more efficient CSV reading/handling<a hidden class="anchor" aria-hidden="true" href="#slightly-more-efficient-csv-readinghandling">#</a></h2>
<h3 id="only-getting-some-columns">Only getting some columns<a hidden class="anchor" aria-hidden="true" href="#only-getting-some-columns">#</a></h3>
<p>This is a three-stage process, but it saves memory, and leads to faster reading too, which is a bonus! Notice how, without this, it can be a big TSV to read:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../gene_exp/E-MTAB-5214-query-results.tpms.tsv&#34;</span>
gtex <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(PATH, comment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;#&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>)
gtex
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>Let&rsquo;s do this a bit better:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_col</span>(column_name: str) <span style="color:#f92672">-&gt;</span> bool:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Simple function to filter column names
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;gene&#34;</span> <span style="color:#f92672">in</span> column_name<span style="color:#f92672">.</span>lower() <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;blood&#34;</span> <span style="color:#f92672">in</span> column_name<span style="color:#f92672">.</span>lower():
        <span style="color:#66d9ef">return</span> True
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> False


<span style="color:#75715e"># Get the header by reading the first line</span>
header <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(PATH, nrows <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>, comment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;#&#39;</span>)<span style="color:#f92672">.</span>columns

<span style="color:#75715e"># Filter the columns of interest</span>
usecols <span style="color:#f92672">=</span> [c <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> header <span style="color:#66d9ef">if</span> get_col(c)]

<span style="color:#75715e"># now read it</span>
gtex <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(PATH, usecols <span style="color:#f92672">=</span> usecols, comment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;#&#39;</span>, sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>) 
gtex
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h3 id="chunkifying-data">Chunkifying data<a hidden class="anchor" aria-hidden="true" href="#chunkifying-data">#</a></h3>
<p>I have to credit my old colleague Magda for this trick:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> re
pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;^IL1[A-Z]$&#34;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">filter_interleukin1</span>(chunk):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Apply a regex to filter out chunks
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> chunk[
        chunk[<span style="color:#e6db74">&#39;Gene Name&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> z: True <span style="color:#66d9ef">if</span> pattern<span style="color:#f92672">.</span>findall(z) <span style="color:#66d9ef">else</span> False)
    ]


gtex <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(
    [filter_interleukin1(chunk) <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;../gene_exp/E-MTAB-5214-query-results.tpms.tsv&#34;</span>, 
                                    sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>, comment <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#&#39;</span>,
                                    iterator<span style="color:#f92672">=</span>True, chunksize<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>)]
)
gtex
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h3 id="memory-efficiency">Memory efficiency<a hidden class="anchor" aria-hidden="true" href="#memory-efficiency">#</a></h3>
<p>This is not what I do immediately, but I find that it sometimes has benefits, especially when memory is a
bit precious and I have to make ends meet:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;numeric_column&#39;</span>], downcast<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;unsigned&#39;</span>) <span style="color:#75715e"># only really works for positive integers</span>
pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;numeric_column&#39;</span>], downcast<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Sparse[int]&#39;</span>) <span style="color:#75715e"># more effective with lots of 0s</span>
df[<span style="color:#e6db74">&#39;column&#39;</span>]<span style="color:#f92672">.</span>astype(bool) <span style="color:#75715e"># is your data full of 0s and 1s...?</span>
</code></pre></div><h2 id="sql-for-pandas">SQL(?) for Pandas<a hidden class="anchor" aria-hidden="true" href="#sql-for-pandas">#</a></h2>
<p>Yes, you can call SQL via Pandas, e.g.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect() <span style="color:#75715e"># or a sqlalchemy connection... etc.</span>
pd<span style="color:#f92672">.</span>read_sql(<span style="color:#e6db74">&#34;&#34;&#34;SELECT * FROM ... &#34;&#34;&#34;</span>, con <span style="color:#f92672">=</span> conn)
</code></pre></div><p>but you can also write string queries for your Pandas data! Let&rsquo;s look at <code>iris</code> again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">5</span>)
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># you may know this as df[df[&#39;species&#39;] == &#39;setosa&#39;]</span>
df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;species == &#39;setosa&#39;&#34;</span>)<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>I find this is slightly more readable, especially when there&rsquo;s lots of conditions, such as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># you may know this as df[(df[&#39;species&#39;] == &#39;setosa&#39;)&amp;(df[&#39;sepal width (cm)&#39;] &lt; 3.2)]</span>
df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;species == &#39;setosa&#39; and `sepal width (cm)` &lt; 3.2&#34;</span>)<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h2 id="serialisation">Serialisation<a hidden class="anchor" aria-hidden="true" href="#serialisation">#</a></h2>
<p>While TSV/CSV is the go-to format for many, I&rsquo;ve found that working with them can be a bit of a pain,
especially when my files get big. Some formats I&rsquo;ve played with lately are Apache&rsquo;s <code>feather</code> and <code>Parquet</code>
formats.</p>
<p>While they sometimes don&rsquo;t offer as much compression as the humble <code>gzip</code>, they&rsquo;re still much
better at reading; remember to have <code>pyarrow</code> installed!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df<span style="color:#f92672">.</span>to_parquet()
pd<span style="color:#f92672">.</span>read_parquet()
</code></pre></div><p>Next time I&rsquo;ll cover <code>numba</code>, which has been one of the most exciting things I&rsquo;ve worked with lately.</p>

</div>
  <footer class="post-footer">
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2021 <a href="https://ideasbyjin.github.io/">Read between the rows</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>



<script defer src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
